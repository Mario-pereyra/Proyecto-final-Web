<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba Chat - Mario como Comprador</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .conversation {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 10px 0;
            padding: 15px;
            background: #f9f9f9;
        }
        .conversation.active {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .message {
            margin: 8px 0;
            padding: 10px;
            border-radius: 8px;
            max-width: 80%;
        }
        .message.sent {
            background: #2196f3;
            color: white;
            margin-left: auto;
        }
        .message.received {
            background: #e0e0e0;
            color: #333;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .input-group input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .btn {
            padding: 10px 20px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #1976d2;
        }
        .btn.secondary {
            background: #666;
        }
        .product-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f0f8ff;
            border-radius: 5px;
        }
        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background: #e8f5e8;
            border-left: 4px solid #4caf50;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>    <div class="header">
        <h1>üõí Chat de Prueba - Mario como Comprador</h1>
        <p>Simulando: Mario Pereyra consultando productos de Paula Mendez</p>
        <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 5px; margin-top: 10px;">
            <small>
                <strong>Objetivo:</strong> Demostrar a Mario Pereyra actuando como COMPRADOR consultando productos de otros vendedores<br>
                <strong>Estado:</strong> <span id="estado-demo">Cargando...</span>
            </small>
        </div>
    </div>

    <div class="container">
        <div class="panel">
            <h2>üìã Conversaciones Disponibles</h2>
            <div id="conversaciones-list">
                <div class="status">Cargando conversaciones...</div>
            </div>
              <div class="input-group">
                <button class="btn" onclick="cargarConversaciones()">üîÑ Recargar Conversaciones</button>
                <button class="btn secondary" onclick="cambiarAVendedor()">ÔøΩ Ver como Paula</button>
                <button class="btn secondary" onclick="cambiarAMario()">üë® Ver como Mario</button>
            </div>
              <div class="input-group">
                <button class="btn" onclick="crearConversacionPrueba()">‚ûï Crear Conversaci√≥n de Prueba</button>
                <button class="btn" onclick="demostrarMarioComprador()" style="background: #4caf50;">üéØ DEMOSTRAR: Mario Comprador</button>
            </div>
        </div>

        <div class="panel">
            <h2>üí¨ Chat Activo</h2>
            <div id="producto-info" style="display: none;"></div>
            <div id="mensajes-container">
                <div class="status">Selecciona una conversaci√≥n para ver los mensajes</div>
            </div>
            
            <div class="input-group" id="enviar-mensaje" style="display: none;">
                <input type="text" id="nuevo-mensaje" placeholder="Escribe tu mensaje...">
                <button class="btn" onclick="enviarMensaje()">üì§ Enviar</button>
            </div>
        </div>
    </div>

    <div class="panel" style="margin-top: 20px;">
        <h3>üìä Log de Actividad</h3>
        <div id="activity-log" class="log">Iniciando sistema de chat...</div>        <button class="btn" onclick="limpiarLog()">üóëÔ∏è Limpiar Log</button>
        <button class="btn" onclick="demostrarMarioComprador()" style="background: #4caf50;">üéØ DEMO ESPEC√çFICO</button>
        <button class="btn secondary" onclick="crearConversacionPrueba()">‚ûï Nueva Conversaci√≥n</button>
    </div>

    <script src="js/mensajesSimple.js"></script>
    <script>
        let usuarioActual = { usuarioId: 1, nombre: 'Mario Pereyra' };
        let conversacionActiva = null;
        let mensajesPorConversacion = {};
        let longPollingActivo = false;

        // Configurar usuario en localStorage
        localStorage.setItem('usuarioId', '1');
        localStorage.setItem('usuarioNombre', 'Mario Pereyra');

        function log(mensaje) {
            const logElement = document.getElementById('activity-log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${mensaje}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${mensaje}`);
        }

        function limpiarLog() {
            document.getElementById('activity-log').innerHTML = 'Log limpiado...\n';
        }        async function cargarConversaciones() {
            log('üîç Cargando conversaciones de Mario...');
            
            try {
                const response = await fetch(`/api/chat/conversaciones/usuario/${usuarioActual.usuarioId}`);
                const data = await response.json();
                
                // La API devuelve {conversaciones: [...]} o {message: "...", conversaciones: []}
                const conversaciones = data.conversaciones || [];
                  log(`‚úÖ ${conversaciones.length} conversaciones encontradas`);
                
                // Actualizar estado
                const conversacionesComprador = conversaciones.filter(c => c.compradorId === usuarioActual.usuarioId);
                const conversacionesVendedor = conversaciones.filter(c => c.vendedorId === usuarioActual.usuarioId);
                
                document.getElementById('estado-demo').innerHTML = 
                    `${conversacionesComprador.length} como comprador, ${conversacionesVendedor.length} como vendedor`;
                
                const container = document.getElementById('conversaciones-list');
                container.innerHTML = '';
                
                if (conversaciones.length === 0) {
                    container.innerHTML = '<div class="status">No hay conversaciones disponibles. Usa "Crear Conversaci√≥n de Prueba"</div>';
                    return;
                }
                
                for (const conv of conversaciones) {
                    const div = document.createElement('div');
                    div.className = 'conversation';
                    div.onclick = () => seleccionarConversacion(conv);
                      // Determinar el rol y el otro usuario
                    const esComprador = conv.compradorId === usuarioActual.usuarioId;
                    const otroUsuario = esComprador ? conv.vendedorNombre : conv.compradorNombre;
                    const rol = esComprador ? 'üõí Comprador' : 'üè™ Vendedor';
                    const rolOtro = esComprador ? 'Vendedor' : 'Comprador';
                    
                    // Obtener imagen del anuncio
                    const imagenUrl = conv.anuncioImagen ? `/${conv.anuncioImagen}` : '/recursos/imagenes/placeholder.jpg';
                    
                    // Color del borde seg√∫n el rol
                    const colorBorde = esComprador ? '#4caf50' : '#2196f3';
                    
                    div.innerHTML = `
                        <div class="product-info" style="border-left: 4px solid ${colorBorde};">
                            <img src="${imagenUrl}" 
                                 class="product-image" 
                                 onerror="this.src='/recursos/imagenes/placeholder.jpg'">
                            <div>
                                <strong>${conv.anuncioTitulo}</strong><br>
                                <small><strong>${usuarioActual.nombre}:</strong> ${rol}</small><br>
                                <small><strong>${otroUsuario}:</strong> ${rolOtro}</small><br>
                                <small>ÔøΩ Conv ID: ${conv.conversacionId}</small>
                            </div>
                        </div>
                        <small><strong>√öltimo mensaje:</strong> ${conv.ultimoMensaje || 'Sin mensajes'}</small><br>
                        <small><strong>Fecha:</strong> ${new Date(conv.fecha_ultimo_mensaje).toLocaleString()}</small>
                    `;
                    
                    container.appendChild(div);
                }
                
            } catch (error) {
                log(`‚ùå Error cargando conversaciones: ${error.message}`);
            }
        }        async function seleccionarConversacion(conversacion) {
            log(`üì± Seleccionando conversaci√≥n ${conversacion.conversacionId}: ${conversacion.anuncioTitulo}`);
            
            conversacionActiva = conversacion;
            
            // Marcar conversaci√≥n como activa visualmente
            document.querySelectorAll('.conversation').forEach(c => c.classList.remove('active'));
            event.target.closest('.conversation').classList.add('active');
            
            // Mostrar informaci√≥n del producto
            const productoInfo = document.getElementById('producto-info');
            const esComprador = conversacion.compradorId === usuarioActual.usuarioId;
            const otroUsuario = esComprador ? conversacion.vendedorNombre : conversacion.compradorNombre;
            const imagenUrl = conversacion.anuncioImagen ? `/${conversacion.anuncioImagen}` : '/recursos/imagenes/placeholder.jpg';
            
            productoInfo.innerHTML = `
                <div class="product-info">
                    <img src="${imagenUrl}" 
                         class="product-image" 
                         onerror="this.src='/recursos/imagenes/placeholder.jpg'">
                    <div>
                        <strong>${conversacion.anuncioTitulo}</strong><br>
                        <small>Conversaci√≥n con: <strong>${otroUsuario}</strong></small><br>
                        <small>Tu rol: <strong>${esComprador ? 'Comprador' : 'Vendedor'}</strong></small><br>
                        <small>√öltimo mensaje: ${conversacion.ultimoMensaje || 'Sin mensajes'}</small>
                    </div>
                </div>
            `;
            productoInfo.style.display = 'block';
            
            // Cargar mensajes
            await cargarMensajes(conversacion.conversacionId);
            
            // Mostrar formulario de env√≠o
            document.getElementById('enviar-mensaje').style.display = 'flex';
            
            // Iniciar long polling
            iniciarLongPolling();
        }

        async function cargarMensajes(conversacionId) {
            try {
                const response = await fetch(`/api/chat/mensajes/${conversacionId}`);
                const mensajes = await response.json();
                
                mensajesPorConversacion[conversacionId] = mensajes;
                mostrarMensajes(mensajes);
                
                log(`üí¨ ${mensajes.length} mensajes cargados para conversaci√≥n ${conversacionId}`);
                
            } catch (error) {
                log(`‚ùå Error cargando mensajes: ${error.message}`);
            }
        }

        function mostrarMensajes(mensajes) {
            const container = document.getElementById('mensajes-container');
            container.innerHTML = '';
            
            mensajes.forEach(mensaje => {
                const div = document.createElement('div');
                const esMio = mensaje.autorId === usuarioActual.usuarioId;
                div.className = `message ${esMio ? 'sent' : 'received'}`;
                
                div.innerHTML = `
                    <strong>${mensaje.autorNombre}:</strong><br>
                    ${mensaje.contenido}<br>
                    <small>${new Date(mensaje.fechaEnvio).toLocaleString()}</small>
                `;
                
                container.appendChild(div);
            });
            
            container.scrollTop = container.scrollHeight;
        }

        async function enviarMensaje() {
            if (!conversacionActiva) return;
            
            const input = document.getElementById('nuevo-mensaje');
            const contenido = input.value.trim();
            
            if (!contenido) return;
            
            try {
                const response = await fetch('/api/chat/mensajes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        conversacionId: conversacionActiva.conversacionId,
                        autorId: usuarioActual.usuarioId,
                        contenido: contenido
                    })
                });
                
                const resultado = await response.json();
                log(`üì§ Mensaje enviado: "${contenido}"`);
                
                input.value = '';
                
                // Recargar mensajes inmediatamente
                await cargarMensajes(conversacionActiva.conversacionId);
                
            } catch (error) {
                log(`‚ùå Error enviando mensaje: ${error.message}`);
            }
        }

        function iniciarLongPolling() {
            if (longPollingActivo) return;
            longPollingActivo = true;
            
            async function polling() {
                if (!conversacionActiva || !longPollingActivo) return;
                
                try {
                    const ultimoMensajeId = mensajesPorConversacion[conversacionActiva.conversacionId]?.slice(-1)[0]?.mensajeId || 0;
                    
                    const response = await fetch(`/api/chat/long-poll/${conversacionActiva.conversacionId}?ultimoMensajeId=${ultimoMensajeId}`);
                    
                    if (response.ok) {
                        const nuevosMensajes = await response.json();
                        
                        if (nuevosMensajes.length > 0) {
                            log(`üîî ${nuevosMensajes.length} nuevos mensajes recibidos`);
                            await cargarMensajes(conversacionActiva.conversacionId);
                        }
                    }
                    
                } catch (error) {
                    // Silenciar errores de long polling
                }
                
                // Continuar polling
                setTimeout(polling, 2000);
            }
            
            polling();
        }        function cambiarAVendedor() {
            usuarioActual = { usuarioId: 2, nombre: 'Paula Mendez' };
            localStorage.setItem('usuarioId', '2');
            localStorage.setItem('usuarioNombre', 'Paula Mendez');
            
            document.querySelector('.header h1').textContent = 'üè™ Chat de Prueba - Paula como Vendedora';
            document.querySelector('.header p').textContent = 'Simulando: Paula Mendez respondiendo a compradores';
            
            log('üîÑ Cambiado a perspectiva de Paula Mendez (Vendedora)');
            
            longPollingActivo = false;
            conversacionActiva = null;
            document.getElementById('enviar-mensaje').style.display = 'none';
            document.getElementById('producto-info').style.display = 'none';
            document.getElementById('mensajes-container').innerHTML = '<div class="status">Selecciona una conversaci√≥n para ver los mensajes</div>';
            
            cargarConversaciones();
        }

        function cambiarAMario() {
            usuarioActual = { usuarioId: 1, nombre: 'Mario Pereyra' };
            localStorage.setItem('usuarioId', '1');
            localStorage.setItem('usuarioNombre', 'Mario Pereyra');
            
            document.querySelector('.header h1').textContent = 'üõí Chat de Prueba - Mario como Comprador';
            document.querySelector('.header p').textContent = 'Simulando: Mario Pereyra consultando productos';
            
            log('üîÑ Cambiado a perspectiva de Mario Pereyra');
            
            longPollingActivo = false;
            conversacionActiva = null;
            document.getElementById('enviar-mensaje').style.display = 'none';
            document.getElementById('producto-info').style.display = 'none';
            document.getElementById('mensajes-container').innerHTML = '<div class="status">Selecciona una conversaci√≥n para ver los mensajes</div>';
            
            cargarConversaciones();
        }        async function crearConversacionPrueba() {
            log('üîß Creando conversaci√≥n de prueba donde Mario act√∫a como comprador...');
            
            try {
                // Crear mensaje donde Mario consulta un anuncio existente
                // Usaremos un anuncio existente pero simularemos que Mario es comprador
                const response = await fetch('/api/chat/mensajes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        anuncioId: 3, // Samsung Galaxy S24 
                        compradorId: 1, // Mario como comprador
                        vendedorId: 2,  // Paula como vendedora (simulado)
                        autorId: 1,     // Mario env√≠a el mensaje
                        contenido: `[MARIO COMPRADOR] Hola, me interesa este Samsung Galaxy S24. ¬øEst√° disponible? ¬øPodr√≠as darme m√°s detalles sobre el estado? - ${new Date().toLocaleTimeString()}`
                    })
                });
                
                if (response.ok) {
                    const resultado = await response.json();
                    log(`‚úÖ Conversaci√≥n creada donde Mario es COMPRADOR: Conv ID ${resultado.conversacionId}`);
                    
                    // Simular respuesta autom√°tica de Paula como vendedora
                    setTimeout(async () => {
                        const respuestaPaula = await fetch('/api/chat/mensajes', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                conversacionId: resultado.conversacionId,
                                autorId: 2, // Paula responde como vendedora
                                contenido: `¬°Hola Mario! S√≠, el Samsung Galaxy S24 est√° disponible. Es pr√°cticamente nuevo, lo compr√© hace 3 meses pero casi no lo uso. Incluye cargador original, caja y protector de pantalla.`
                            })
                        });
                        
                        if (respuestaPaula.ok) {
                            log('‚úÖ Paula responde como vendedora');
                            
                            // Otra pregunta de Mario como comprador
                            setTimeout(async () => {
                                const preguntaMario = await fetch('/api/chat/mensajes', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        conversacionId: resultado.conversacionId,
                                        autorId: 1,
                                        contenido: `Perfecto Paula. ¬øCu√°l ser√≠a el mejor precio que me podr√≠as hacer? ¬øY d√≥nde podr√≠amos encontrarnos para verlo?`
                                    })
                                });
                                
                                if (preguntaMario.ok) {
                                    log('‚úÖ Mario hace pregunta de seguimiento como comprador');
                                }
                            }, 2000);
                        }
                    }, 1500);
                    
                    // Recargar conversaciones para mostrar la nueva
                    setTimeout(() => {
                        cargarConversaciones();
                    }, 4000);
                } else {
                    const error = await response.text();
                    log(`‚ùå Error creando conversaci√≥n: ${error}`);
                }
                
            } catch (error) {
                log(`‚ùå Error en crearConversacionPrueba: ${error.message}`);
            }
        }        async function demostrarMarioComprador() {
            log('ÔøΩ DEMOSTRACI√ìN ESPEC√çFICA: Mario Pereyra como comprador consultando a Paula Mendez');
            
            // Asegurar que estamos en perspectiva de Mario
            if (usuarioActual.usuarioId !== 1) {
                cambiarAMario();
                log('üîÑ Cambiado a perspectiva de Mario');
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            log('üë§ Usuario actual: Mario Pereyra (ID: 1)');
            log('üìã Objetivo: Mario consulta productos de Paula como comprador');
            
            // Crear conversaci√≥n espec√≠fica
            try {
                log('üìù Creando conversaci√≥n donde Mario consulta producto de Paula...');
                
                const response = await fetch('/api/chat/mensajes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        anuncioId: 4, // iPhone 13 Pro Max
                        compradorId: 1, // Mario como COMPRADOR
                        vendedorId: 2,  // Paula como VENDEDORA
                        autorId: 1,     // Mario env√≠a el mensaje inicial
                        contenido: `Hola Paula, soy Mario Pereyra. Vi tu anuncio del iPhone 13 Pro Max y me interesa mucho. ¬øPodr√≠as contarme m√°s sobre el estado del dispositivo? ¬øIncluye accesorios originales?`
                    })
                });
                
                if (response.ok) {
                    const resultado = await response.json();
                    const convId = resultado.conversacionId;
                    log(`‚úÖ Conversaci√≥n creada: Mario (comprador) ‚Üí Paula (vendedora) | Conv ID: ${convId}`);
                    
                    // Simular respuesta de Paula como vendedora
                    setTimeout(async () => {
                        await fetch('/api/chat/mensajes', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                conversacionId: convId,
                                autorId: 2, // Paula responde
                                contenido: `¬°Hola Mario! Gracias por tu inter√©s. El iPhone est√° en excelente estado, lo he cuidado mucho. Incluye caja original, cargador Lightning, y cable USB-C. Tambi√©n tiene protector de pantalla instalado desde el primer d√≠a.`
                            })
                        });
                        log('üì± Paula responde como vendedora');
                        
                        // Mario hace otra pregunta como comprador
                        setTimeout(async () => {
                            await fetch('/api/chat/mensajes', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    conversacionId: convId,
                                    autorId: 1, // Mario pregunta
                                    contenido: `Suena perfecto Paula. ¬øLa bater√≠a est√° en buen estado? ¬øY tienes la factura de compra? Me gustar√≠a saber si a√∫n tiene garant√≠a.`
                                })
                            });
                            log('üîã Mario pregunta sobre bater√≠a y garant√≠a (como comprador)');
                            
                            // Respuesta final de Paula
                            setTimeout(async () => {
                                await fetch('/api/chat/mensajes', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        conversacionId: convId,
                                        autorId: 2,
                                        contenido: `S√≠ Mario, la bater√≠a est√° al 95% de salud seg√∫n los ajustes. Tengo la factura original de Tigo, la compr√© en marzo 2024, as√≠ que a√∫n tiene garant√≠a hasta marzo 2025. ¬øTe gustar√≠a que nos encontremos para que lo veas?`
                                    })
                                });
                                log('‚úÖ Paula confirma detalles y propone encuentro');
                                
                                // Recargar conversaciones despu√©s de todos los mensajes
                                setTimeout(() => {
                                    cargarConversaciones();
                                    log('üéâ DEMOSTRACI√ìN COMPLETADA: Mario actu√≥ como COMPRADOR consultando a Paula como VENDEDORA');
                                }, 1000);
                            }, 3000);
                        }, 3000);
                    }, 2000);
                } else {
                    const error = await response.text();
                    log(`‚ùå Error en demostraci√≥n: ${error}`);
                }
            } catch (error) {
                log(`‚ùå Error: ${error.message}`);
            }
        }

        // Event listener para Enter en el input
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('nuevo-mensaje').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    enviarMensaje();
                }
            });
        });

        // Inicializar al cargar la p√°gina
        window.onload = function() {
            log('üöÄ Sistema de chat iniciado');
            log(`üë§ Usuario actual: ${usuarioActual.nombre} (ID: ${usuarioActual.usuarioId})`);
            cargarConversaciones();
        };
    </script>
</body>
</html>
